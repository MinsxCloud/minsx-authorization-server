<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>米斯云平台登录</title>
    <link rel="stylesheet" type="text/css" href="css/login.css">
    <link rel="stylesheet" type="text/css" href="frame/layui/css/layui.css"/>
    <script src="js/jquery.min.js"></script>
    <script src="js/axios.js"></script>
    <script src="js/minsx.js"></script>
    <script src="js/gt.js"></script>
    <script src="js/js.cookie.js"></script>
    <script src="frame/layui/layui.js"></script>

</head>
<body>
<div class="top">
</div>
<div class="main">
    <div class="content">
        <!--notice-->
        <div class="notice">

            <p style="text-align:center;">
                <strong><span style="font-size:24px;"><span style="color:#E56600;"><br/>
            </span></span></strong>
            </p>
            <p style="text-align:center;">
                <strong><span style="font-size:24px;"><span style="color:#E56600;"><br/>
            </span></span></strong>
            </p>
            <p style="text-align:center;">
                <strong><span style="font-size:24px;"><span style="color:#E56600;"><br/>
            </span></span></strong>
            </p>
            <p style="text-align:center;">
                <strong><span style="font-size:24px;"><span style="color:#E56600;font-family:Microsoft YaHei,serif;">Minsx</span><span
                        style="font-family:Microsoft YaHei,serif;"> 米斯云平台</span></span></strong>
            </p>
            <p style="text-align:center;">
                <strong><span style="font-size:24px;color:#333333;"><span
                        style="color:#333333;font-family:-apple-system, BlinkMacSystemFont, Microsoft YaHei,serif;font-size:14px;"><span
                        style="font-size:14px;font-family:Microsoft YaHei,serif;color:#333333;">是一款基于Spring的轻量级云平台框架</span></span></span></strong><strong><span
                    style="font-size:14px;"><span
                    style="color:#999999;font-family:-apple-system, BlinkMacSystemFont, Microsoft YaHei,serif;font-size:14px;background-color:#FFFFFF;"><span
                    style="font-size:14px;"><span
                    style="font-family:Microsoft YaHei,serif;font-size:14px;"></span></span></span></span></strong>
            </p>
            <p style="text-align:center;">
                <strong><span style="font-size:14px;color:#333333;"><span
                        style="color:#333333;font-family:Microsoft YaHei,serif;font-size:14px;">她可以让你以较短的时间开发出企业级云平台应用</span></span></strong>
            </p>
            <p style="text-align:center;">
                <strong><span style="font-size:14px;color:#999999;"><span
                        style="color:#999999;font-family:Microsoft YaHei,serif;font-size:14px;"><br/>
            </span></span></strong>
            </p>
            <p style="text-align:center;">
                <span style="font-size:12px;font-family:Microsoft YaHei,serif;color:#333333;"><span
                        style="color:#333333;font-family:Microsoft YaHei,serif;font-size:12px;"><strong>如果您有兴趣欢迎加入我们</strong></span></span>
            </p>
            <p style="text-align:center;">
                <span style="font-size:12px;font-family:Microsoft YaHei,serif;color:#333333;"><span
                        style="color:#333333;font-family:Microsoft YaHei,serif;font-size:12px;"><strong>E-mail：support@minsx.com</strong></span></span>
            </p>
            <p style="text-align:center;">
                <span style="font-size:14px;font-family:Microsoft YaHei,serif;"><span
                        style="color:#999999;font-family:Microsoft YaHei,serif;"><span
                        style="font-size:12px;color:#333333;"><strong>Git：</strong></span><span
                        style="font-size:12px;color:#333333;"><strong>https://github.com/MinsxCloud</strong></span></span></span>
            </p>

        </div>

        <!--register-->
        <div class="register" id="registerBox">
            <div class="register-header">
            </div>
            <div class="register-username">
                <div class="input-ico"><i class="layui-icon" style="font-size: 30px;">&#xe609;</i></div>
                <div class="main-input-outside">
                    <input type="text" name="title" id="register-username-input" placeholder="请输入用户名"
                           class="main-input-inner">
                </div>
            </div>
            <div class="register-password">
                <div class="input-ico"><i class="layui-icon" style="font-size: 30px;">&#xe62c;</i></div>
                <div class="main-input-outside">
                    <input type="email" name="title" id="register-email-input" placeholder="请输入邮箱"
                           class="main-input-inner">
                </div>
            </div>
            <div class="register-rePassword">
                <div class="input-ico"><i class="layui-icon" style="font-size: 30px;">&#xe62c;</i></div>
                <div class="main-input-outside">
                    <input type="password" name="title" id="register-password-input"
                           placeholder="请输入密码" class="main-input-inner">
                </div>
            </div>
            <div class="register-button">
                <button class="layui-btn" id="registerButton" style="width: 300px">注册</button>
            </div>
            <div class="register-footer">
                <a href="javascript:void(0);" onclick="showChangePass()">
                    <div class="main-footer-left">忘记密码?</div>
                </a>
                <a href="javascript:void(0);" onclick="showLogin()">
                    <div class="main-footer-right">立即登录</div>
                </a>
            </div>
        </div>


        <!--changePass-->
        <div class="changePass" id="changePassBox">
            <div class="changePass-header">
            </div>
            <div class="changePass-username">
                <div class="input-ico"><i class="layui-icon" style="font-size: 30px;">&#xe609;</i></div>
                <div class="main-input-outside">
                    <input type="text" id="changePass-username-input" placeholder="请输入用户名/邮箱/手机号"
                           class="main-input-inner">
                    <a href="javascript:void(0);" id="changePassButton">
                        <div class="changePass-sendCode">发送验证码</div>
                    </a>
                </div>
            </div>
            <div class="changePass-password">
                <div class="input-ico"><i class="layui-icon" style="font-size: 30px;">&#xe62c;</i></div>
                <div class="main-input-outside">
                    <input type="password" id="changePass-password-input" placeholder="请输入新密码" class="main-input-inner">
                </div>
            </div>
            <div class="changePass-code">
                <div class="input-ico"><i class="layui-icon" style="font-size: 30px;">&#xe63a;</i></div>
                <div class="main-input-outside">
                    <input type="text" id="changePass-code-input" placeholder="请输入验证码" class="main-input-inner">
                </div>
            </div>
            <div class="changePass-button">
                <button class="layui-btn" style="width: 300px" onclick="changePass()" >修改密码</button>
            </div>
            <div class="changePass-footer">
                <a href="javascript:void(0);" onclick="showLogin()">
                    <div class="main-footer-left">立即登录</div>
                </a>
                <a href="javascript:void(0);" onclick="showRegister()">
                    <div class="main-footer-right">立即注册</div>
                </a>
            </div>
        </div>

        <!--login-->
        <div class="login" id="loginBox">
            <div class="login-header">
            </div>
            <div class="login-username">
                <div class="input-ico"><i class="layui-icon" style="font-size: 30px;">&#xe609;</i></div>
                <div class="main-input-outside">
                    <input type="text" name="title" id="login-username-input" placeholder="请输入用户名/邮箱/手机号码"
                           class="main-input-inner">
                </div>
            </div>
            <div class="login-password">
                <div class="input-ico"><i class="layui-icon" style="font-size: 30px;">&#xe62c;</i></div>
                <div class="main-input-outside">
                    <input type="password" name="title" id="login-password-input" placeholder="请输入密码"
                           class="main-input-inner">
                </div>
            </div>
            <div class="login-remember-me">
                <div class="login-remember-me">
                    <div class="layui-form">
                        <input type="checkbox" name="like1[write]" lay-skin="primary" title="记住密码" checked="">
                    </div>
                </div>
            </div>
            <div class="login-button">
                <button class="layui-btn" id="loginButton" style="width: 300px">登录</button>
            </div>
            <div class="login-footer">
                <a href="javascript:void(0);" onclick="showChangePass()">
                    <div class="main-footer-left">忘记密码?</div>
                </a>
                <a href="javascript:void(0);" onclick="showRegister()">
                    <div class="main-footer-right">立即注册</div>
                </a>
            </div>
        </div>

    </div>
</div>
<div class="lawn">
    <div class="footer-backPic"></div>
    <div class="description">米斯云平台提供计算服务</div>
    <div class="copyright">Copyright © 2016-2017 minsx.com All Rights Reserved</div>
</div>

<script>
    layui.use('form', function () {
    });

    //-----------------------------登录--------------------------------
    $.ajax({
        url: "/verify/initial?t=" + (new Date()).getTime(),
        type: "get",
        dataType: "json",
        success: function (data) {
            initGeetest({
                gt: data.gt,
                challenge: data.challenge,
                offline: !data.success,
                new_captcha: data.new_captcha,
                product: "bind",
                width: "300px"
            }, handlerLogin);
        }
    });

    var handlerLogin = function (captchaObj) {
        captchaObj.onReady(function () {
        }).onSuccess(function () {
            var result = captchaObj.getValidate();
            if (!result) {
                return layer.msg('请完成验证!');
            }
            login(result);
        });
        $('#loginButton').click(function () {
            if ($('#login-username-input').val() === '') {
                layer.msg('用户名不能为空！');
                return;
            } else if ($('#login-password-input').val() === '') {
                layer.msg('密码不能为空！');
                return;
            }
            captchaObj.verify();
        });
    };

    function login(result) {
        let option = {
            headers: {
                'Authorization': 'Basic Z29vZHNhdmU6Z29vZHNhdmU=',
                'Content-Type': 'application/json'
            },
            params: {
                grant_type: 'password',
                resource: 'web',
                username: $('#login-username-input').val(),
                password: $('#login-password-input').val(),
                geetest_challenge: result.geetest_challenge,
                geetest_validate: result.geetest_validate,
                geetest_seccode: result.geetest_seccode
            }
        };
        Minsx.Http.postWithOption("/oauth/token", null, option).then(function (response) {
            if (response.status === 200) {
                const redir = Minsx.Util.getUrlParam("redir");
                Cookies.set('access_token', response.data.access_token, {domain: 'localhost'});
                if (redir === null || redir === '') {
                    window.location.href = 'https://www.minsx.com';
                } else {
                    window.location.href = redir;
                }
            }
        }).catch(function (error) {
            if (error.response.data.error) {
                layer.msg('用户名或密码不正确！');
            } else {
                layer.msg(error.response.data);
            }
        });
    }


    //--------------------注册---------------------------
    $.ajax({
        url: "/verify/initial?t=" + (new Date()).getTime(),
        type: "get",
        dataType: "json",
        success: function (data) {
            initGeetest({
                gt: data.gt,
                challenge: data.challenge,
                offline: !data.success,
                new_captcha: data.new_captcha,
                product: "bind",
                width: "300px"
            }, handlerRegister);
        }
    });

    var handlerRegister = function (captchaObj) {
        captchaObj.onReady(function () {
        }).onSuccess(function () {
            var result = captchaObj.getValidate();
            if (!result) {
                return layer.msg('请完成验证!');
            }
            register(result);
        });
        $('#registerButton').click(function () {
            let data = {
                username: $('#register-username-input').val(),
                email: $('#register-email-input').val(),
                password: $('#register-password-input').val()
            };
            if (data.username === '') {
                layer.msg('用户名不能为空！');
                return;
            } else if (data.email === '' ) {
                layer.msg('邮箱不能为空！');
                return;
            }else if (data.password === '') {
                layer.msg('密码不能为空！');
                return;
            }
            captchaObj.verify();
        });
    };

    function register(result) {
        let data = {
            username: $('#register-username-input').val(),
            email: $('#register-email-input').val(),
            password: $('#register-password-input').val(),
            geetest_challenge: result.geetest_challenge,
            geetest_validate: result.geetest_validate,
            geetest_seccode: result.geetest_seccode
        };
        Minsx.Http.post("/system/register", null, data).then(function (response) {
            if (response.status === 200) {
                layer.msg('注册成功！');
                $('#login-username-input').val(data.username);
                $('#login-password-input').val(data.password);
                showLogin();
            }
        }).catch(function (error) {
            layer.msg(error.response.data);
        });
    }

    //--------------------修改密码---------------------------
    function changePass() {
        let data = {
            username: $('#changePass-username-input').val(),
            password: $('#changePass-password-input').val(),
            emailCode: $('#changePass-code-input').val()
        };
        if (data.username === null || data.username === '') {
            layer.msg('用户名不能为空');
            return;
        }
        if (data.password === null || data.password === '') {
            layer.msg('密码不能为空');
            return;
        }
        if (data.emailCode === null || data.emailCode === '') {
            layer.msg('验证码不能为空');
            return;
        }
        Minsx.Http.put("/system/changePass", null, data).then(function (response) {
            if (response.status === 200) {
                layer.msg('修改密码成功！');
                $('#login-username-input').val(data.username);
                $('#login-password-input').val(data.password);
                showLogin();
            }
        }).catch(function (error) {
            layer.msg(error.response.data);
        });
    }

    $.ajax({
        url: "/verify/initial?t=" + (new Date()).getTime(),
        type: "get",
        dataType: "json",
        success: function (data) {
            initGeetest({
                gt: data.gt,
                challenge: data.challenge,
                offline: !data.success,
                new_captcha: data.new_captcha,
                product: "bind",
                width: "300px"
            }, handlerSendCode);
        }
    });

    var handlerSendCode = function (captchaObj) {
        captchaObj.onReady(function () {
        }).onSuccess(function () {
            var result = captchaObj.getValidate();
            if (!result) {
                return layer.msg('请完成验证!');
            }
            sendCode(result);
        });
        $('#changePassButton').click(function () {
            var username = $('#changePass-username-input').val();
            if (username === null || username === '') {
                layer.msg('用户名不能为空');
                return;
            }
            captchaObj.verify();
        });
    };

    function sendCode(result) {
        let data = {
            username: $('#changePass-username-input').val(),
            geetest_challenge: result.geetest_challenge,
            geetest_validate: result.geetest_validate,
            geetest_seccode: result.geetest_seccode
        };
        Minsx.Http.get("/system/getEmailCode", data).then(function (response) {
            if (response.status === 200) {
                layer.tips('验证码已发送到您的邮箱', '#changePass-code-input');
            }
        }).catch(function (error) {
            layer.msg(error.response.data);
        });
    }

    $("#registerBox").hide();
    $("#changePassBox").hide();

    function showRegister() {
        $("#loginBox").hide();
        $("#changePassBox").hide();
        $("#registerBox").show();
    }

    function showLogin() {
        $("#registerBox").hide();
        $("#changePassBox").hide();
        $("#loginBox").show();
    }

    function showChangePass() {
        $("#registerBox").hide();
        $("#loginBox").hide();
        $("#changePassBox").show();
    }
</script>
</body>
</html>